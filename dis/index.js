"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _rxjs=require("rxjs"),_babelPluginConvertCall=_interopRequireWildcard(require("./babel-plugins/babel-plugin-convert-call"));function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)if(Object.prototype.hasOwnProperty.call(a,c)){var d=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(a,c):{};d.get||d.set?Object.defineProperty(b,c,d):b[c]=a[c]}return b.default=a,b}function _objectSpread(a){for(var b=1;b<arguments.length;b++){var c=null==arguments[b]?{}:arguments[b],d=Object.keys(c);"function"==typeof Object.getOwnPropertySymbols&&(d=d.concat(Object.getOwnPropertySymbols(c).filter(function(a){return Object.getOwnPropertyDescriptor(c,a).enumerable}))),d.forEach(function(b){_defineProperty(a,b,c[b])})}return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var babel=require("@babel/standalone"),sanboxEngine=require("./engine"),DEFAULT_PRESETS=["es2017",["stage-0",{legacy:!1,decoratorsBeforeExport:!0}]],DEFAULT_PLUGINS=["transform-spread","transform-classes","transform-block-scoping","proposal-function-bind","transform-arrow-functions","proposal-class-properties","transform-async-to-generator","proposal-object-rest-spread","proposal-export-default-from","transform-block-scoped-functions","proposal-async-generator-functions",_babelPluginConvertCall.pluginName],Sandbox=/*#__PURE__*/function(){function a(b,c){var d=this,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0,f=3<arguments.length&&void 0!==arguments[3]?arguments[3]:void 0;_classCallCheck(this,a),this.presets=e||DEFAULT_PRESETS,this.plugins=f||DEFAULT_PLUGINS,this.variables=c,this.responseObserver=null,this.responseSubscription=null,this.responseObservable=new _rxjs.Observable(function(a){d.responseObserver=a}),this.global=this.prepareGlobalObjects(b||{}),babel.registerPlugin(_babelPluginConvertCall.pluginName,_babelPluginConvertCall.default)}return _createClass(a,[{key:"prepareGlobalObjects",value:function b(a){return _objectSpread({// Type
String:String,Object:Object,Array:Array,Number:Number,Date:Date,Error:Error,// Global function
JSON:JSON,Symbol:Symbol,Promise:Promise,Math:Math,RegExp:RegExp},this.customGlobalObjects(),a)}},{key:"exec",value:function e(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};try{a="\n  async function main () {\n    ".concat(a,"\n  }\n  main()\n");var f=babel.transform(a,{presets:this.presets,plugins:this.plugins}).code;this.responseSubscription&&this.responseSubscription.unsubscribe(),this.responseSubscription=this.responseObservable.subscribe({next:b.onMessage||void 0,error:b.onError||void 0,complete:this.processComplete});var c=sanboxEngine.compileSanbox(f),d=c(_objectSpread({},this.global,{window:this.global}),this.variables||{});d&&this.sendOutput(d)}catch(a){return a.message}}},{key:"sendOutput",value:function b(a){this.responseObserver&&this.responseObserver.next(a)}},{key:"processComplete",value:function a(){this.responseSubscription&&this.responseSubscription.unsubscribe(),this.responseSubscription=null}},{key:"customGlobalObjects",value:function b(){var a=this;return{clearInterval:function(a){function b(){return a.apply(this,arguments)}return b.toString=function(){return a.toString()},b}(function(a){clearInterval(a)}),setInterval:function(a){function b(){return a.apply(this,arguments)}return b.toString=function(){return a.toString()},b}(function(a,b){setInterval(a,b)}),clearTimeout:function(a){function b(){return a.apply(this,arguments)}return b.toString=function(){return a.toString()},b}(function(a){clearTimeout(a)}),setTimeout:function(a){function b(){return a.apply(this,arguments)}return b.toString=function(){return a.toString()},b}(function(a,b){setTimeout(a,b)}),console:{native:console.log,log:function c(b){a.sendOutput(b)}}}}}]),a}();exports.default=Sandbox;